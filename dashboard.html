<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard AutoTTU - Localiza√ß√£o das Motos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        color: white;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-online {
        background-color: #4caf50;
      }
      .status-offline {
        background-color: #f44336;
      }
      .status-manutencao {
        background-color: #ff9800;
      }
      .status-alugada {
        background-color: #2196f3;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
      }

      .card h3 {
        margin-bottom: 15px;
        color: #333;
        font-size: 1.3rem;
      }

      .map-container {
        grid-column: 1 / -1;
        height: 400px;
        border-radius: 15px;
        overflow: hidden;
      }

      #map {
        width: 100%;
        height: 100%;
      }

      .motos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .moto-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #4caf50;
      }

      .moto-card.offline {
        border-left-color: #f44336;
      }
      .moto-card.manutencao {
        border-left-color: #ff9800;
      }
      .moto-card.alugada {
        border-left-color: #2196f3;
      }

      .moto-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .moto-title {
        font-weight: bold;
        font-size: 1.1rem;
      }

      .moto-status {
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
        text-transform: uppercase;
      }

      .status-online-bg {
        background-color: #e8f5e8;
        color: #2e7d32;
      }
      .status-offline-bg {
        background-color: #ffebee;
        color: #c62828;
      }
      .status-manutencao-bg {
        background-color: #fff3e0;
        color: #ef6c00;
      }
      .status-alugada-bg {
        background-color: #e3f2fd;
        color: #1565c0;
      }

      .moto-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        font-size: 0.9rem;
      }

      .detail-item {
        display: flex;
        justify-content: space-between;
      }

      .detail-label {
        color: #666;
      }

      .detail-value {
        font-weight: bold;
      }

      .chart-container {
        position: relative;
        height: 300px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error {
        background-color: #ffebee;
        color: #c62828;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        text-align: center;
      }

      .refresh-btn {
        background: linear-gradient(45deg, #4caf50, #45a049);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1rem;
        margin: 20px auto;
        display: block;
        transition: all 0.3s ease;
      }

      .refresh-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #4caf50;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #666;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }

        .motos-grid {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üèçÔ∏è Dashboard AutoTTU</h1>
        <p>Monitoramento em Tempo Real das Motos</p>
      </div>

      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-number" id="totalMotos">-</div>
          <div class="stat-label">Total de Motos</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="motosOnline">-</div>
          <div class="stat-label">Online</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="motosOffline">-</div>
          <div class="stat-label">Offline</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="motosManutencao">-</div>
          <div class="stat-label">Manuten√ß√£o</div>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="card">
          <h3>üìä Status das Motos</h3>
          <div class="chart-container">
            <canvas id="statusChart"></canvas>
          </div>
        </div>

        <div class="card">
          <h3>üå°Ô∏è Temperatura M√©dia</h3>
          <div class="chart-container">
            <canvas id="tempChart"></canvas>
          </div>
        </div>
      </div>

      <div class="card map-container">
        <h3>üó∫Ô∏è Localiza√ß√£o das Motos</h3>
        <div id="map"></div>
      </div>

      <button class="refresh-btn" onclick="atualizarDados()">
        üîÑ Atualizar Dados
      </button>

      <div id="motosContainer">
        <div class="loading">Carregando dados das motos...</div>
      </div>
    </div>

    <script>
      // Configura√ß√µes
      const API_BASE_URL = "http://localhost:5143/api";
      let map;
      let markers = [];
      let statusChart;
      let tempChart;

      // Inicializar mapa
      function inicializarMapa() {
        map = L.map("map").setView([-23.5505, -46.6333], 13);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "¬© OpenStreetMap contributors",
        }).addTo(map);
      }

      // Inicializar gr√°ficos
      function inicializarGraficos() {
        // Gr√°fico de status
        const statusCtx = document
          .getElementById("statusChart")
          .getContext("2d");
        statusChart = new Chart(statusCtx, {
          type: "doughnut",
          data: {
            labels: ["Online", "Offline", "Manuten√ß√£o", "Alugada"],
            datasets: [
              {
                data: [0, 0, 0, 0],
                backgroundColor: ["#4CAF50", "#f44336", "#ff9800", "#2196F3"],
                borderWidth: 2,
                borderColor: "#fff",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });

        // Gr√°fico de temperatura
        const tempCtx = document.getElementById("tempChart").getContext("2d");
        tempChart = new Chart(tempCtx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Temperatura (¬∞C)",
                data: [],
                borderColor: "#4CAF50",
                backgroundColor: "rgba(76, 175, 80, 0.1)",
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: false,
                min: 15,
                max: 50,
              },
            },
          },
        });
      }

      // Buscar dados das motos
      async function buscarDadosMotos() {
        try {
          const response = await fetch(
            `${API_BASE_URL}/telemetria/motos-localizacao`
          );
          if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
          }
          return await response.json();
        } catch (error) {
          console.error("Erro ao buscar dados:", error);
          throw error;
        }
      }

      // Atualizar estat√≠sticas
      function atualizarEstatisticas(motos) {
        const stats = {
          total: motos.length,
          online: motos.filter((m) => m.ultimaTelemetria?.status === "online")
            .length,
          offline: motos.filter((m) => m.ultimaTelemetria?.status === "offline")
            .length,
          manutencao: motos.filter(
            (m) => m.ultimaTelemetria?.status === "manutencao"
          ).length,
          alugada: motos.filter((m) => m.ultimaTelemetria?.status === "alugada")
            .length,
        };

        document.getElementById("totalMotos").textContent = stats.total;
        document.getElementById("motosOnline").textContent = stats.online;
        document.getElementById("motosOffline").textContent = stats.offline;
        document.getElementById("motosManutencao").textContent =
          stats.manutencao;

        // Atualizar gr√°fico de status
        statusChart.data.datasets[0].data = [
          stats.online,
          stats.offline,
          stats.manutencao,
          stats.alugada,
        ];
        statusChart.update();
      }

      // Atualizar mapa
      function atualizarMapa(motos) {
        // Limpar marcadores existentes
        markers.forEach((marker) => map.removeLayer(marker));
        markers = [];

        motos.forEach((moto) => {
          if (moto.latitude && moto.longitude) {
            const status = moto.ultimaTelemetria?.status || "offline";
            const cor = getCorStatus(status);

            const marker = L.circleMarker([moto.latitude, moto.longitude], {
              radius: 8,
              fillColor: cor,
              color: "#fff",
              weight: 2,
              opacity: 1,
              fillOpacity: 0.8,
            }).addTo(map);

            marker.bindPopup(`
                        <strong>${moto.marca} ${moto.modelo}</strong><br>
                        Placa: ${moto.placa}<br>
                        Status: ${status}<br>
                        ${
                          moto.ultimaTelemetria?.temperatura
                            ? `Temperatura: ${moto.ultimaTelemetria.temperatura}¬∞C<br>`
                            : ""
                        }
                        ${
                          moto.ultimaTelemetria?.velocidade
                            ? `Velocidade: ${moto.ultimaTelemetria.velocidade} km/h<br>`
                            : ""
                        }
                        ${
                          moto.ultimaTelemetria?.bateria
                            ? `Bateria: ${moto.ultimaTelemetria.bateria}%<br>`
                            : ""
                        }
                        √öltima atualiza√ß√£o: ${new Date(
                          moto.ultimaAtualizacao
                        ).toLocaleString()}
                    `);

            markers.push(marker);
          }
        });

        // Ajustar zoom para mostrar todos os marcadores
        if (markers.length > 0) {
          const group = new L.featureGroup(markers);
          map.fitBounds(group.getBounds().pad(0.1));
        }
      }

      // Obter cor do status
      function getCorStatus(status) {
        const cores = {
          online: "#4CAF50",
          offline: "#f44336",
          manutencao: "#ff9800",
          alugada: "#2196F3",
        };
        return cores[status] || "#666";
      }

      // Atualizar lista de motos
      function atualizarListaMotos(motos) {
        const container = document.getElementById("motosContainer");

        if (motos.length === 0) {
          container.innerHTML =
            '<div class="error">Nenhuma moto encontrada com localiza√ß√£o</div>';
          return;
        }

        const html = `
                <div class="motos-grid">
                    ${motos
                      .map((moto) => {
                        const status =
                          moto.ultimaTelemetria?.status || "offline";
                        const ultimaAtualizacao = new Date(
                          moto.ultimaAtualizacao
                        ).toLocaleString();

                        return `
                            <div class="moto-card ${status}">
                                <div class="moto-header">
                                    <div class="moto-title">${moto.marca} ${
                          moto.modelo
                        }</div>
                                    <div class="moto-status status-${status}-bg">${status}</div>
                                </div>
                                <div class="moto-details">
                                    <div class="detail-item">
                                        <span class="detail-label">Placa:</span>
                                        <span class="detail-value">${
                                          moto.placa
                                        }</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Ano:</span>
                                        <span class="detail-value">${
                                          moto.ano
                                        }</span>
                                    </div>
                                    ${
                                      moto.ultimaTelemetria?.temperatura
                                        ? `
                                    <div class="detail-item">
                                        <span class="detail-label">Temperatura:</span>
                                        <span class="detail-value">${moto.ultimaTelemetria.temperatura}¬∞C</span>
                                    </div>
                                    `
                                        : ""
                                    }
                                    ${
                                      moto.ultimaTelemetria?.velocidade
                                        ? `
                                    <div class="detail-item">
                                        <span class="detail-label">Velocidade:</span>
                                        <span class="detail-value">${moto.ultimaTelemetria.velocidade} km/h</span>
                                    </div>
                                    `
                                        : ""
                                    }
                                    ${
                                      moto.ultimaTelemetria?.quilometragem
                                        ? `
                                    <div class="detail-item">
                                        <span class="detail-label">Quilometragem:</span>
                                        <span class="detail-value">${moto.ultimaTelemetria.quilometragem.toLocaleString()} km</span>
                                    </div>
                                    `
                                        : ""
                                    }
                                    ${
                                      moto.ultimaTelemetria?.nivelCombustivel
                                        ? `
                                    <div class="detail-item">
                                        <span class="detail-label">Combust√≠vel:</span>
                                        <span class="detail-value">${moto.ultimaTelemetria.nivelCombustivel}%</span>
                                    </div>
                                    `
                                        : ""
                                    }
                                    ${
                                      moto.ultimaTelemetria?.rotacaoMotor
                                        ? `
                                    <div class="detail-item">
                                        <span class="detail-label">RPM:</span>
                                        <span class="detail-value">${moto.ultimaTelemetria.rotacaoMotor.toLocaleString()}</span>
                                    </div>
                                    `
                                        : ""
                                    }
                                    <div class="detail-item" style="grid-column: 1 / -1;">
                                        <span class="detail-label">√öltima atualiza√ß√£o:</span>
                                        <span class="detail-value">${ultimaAtualizacao}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                      })
                      .join("")}
                </div>
            `;

        container.innerHTML = html;
      }

      // Atualizar gr√°fico de temperatura
      function atualizarGraficoTemperatura(motos) {
        const temperaturas = motos
          .filter((m) => m.ultimaTelemetria?.temperatura)
          .map((m) => m.ultimaTelemetria.temperatura);

        if (temperaturas.length > 0) {
          const media =
            temperaturas.reduce((a, b) => a + b, 0) / temperaturas.length;

          // Adicionar novo ponto ao gr√°fico
          const now = new Date().toLocaleTimeString();
          tempChart.data.labels.push(now);
          tempChart.data.datasets[0].data.push(media);

          // Manter apenas os √∫ltimos 10 pontos
          if (tempChart.data.labels.length > 10) {
            tempChart.data.labels.shift();
            tempChart.data.datasets[0].data.shift();
          }

          tempChart.update();
        }
      }

      // Fun√ß√£o principal de atualiza√ß√£o
      async function atualizarDados() {
        try {
          const motos = await buscarDadosMotos();

          atualizarEstatisticas(motos);
          atualizarMapa(motos);
          atualizarListaMotos(motos);
          atualizarGraficoTemperatura(motos);
        } catch (error) {
          document.getElementById(
            "motosContainer"
          ).innerHTML = `<div class="error">Erro ao carregar dados: ${error.message}</div>`;
        }
      }

      // Inicializar aplica√ß√£o
      function inicializar() {
        inicializarMapa();
        inicializarGraficos();
        atualizarDados();

        // Atualizar dados a cada 30 segundos
        setInterval(atualizarDados, 30000);
      }

      // Iniciar quando a p√°gina carregar
      document.addEventListener("DOMContentLoaded", inicializar);
    </script>
  </body>
</html>
